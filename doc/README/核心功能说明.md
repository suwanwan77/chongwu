# 宠物管理系统 - 核心功能说明

## 目录
- [功能概览](#功能概览)
- [用户管理系统](#用户管理系统)
- [宠物信息管理](#宠物信息管理)
- [商品管理系统](#商品管理系统)
- [订单管理系统](#订单管理系统)
- [服务预约系统](#服务预约系统)
- [支付系统](#支付系统)
- [通知系统](#通知系统)
- [数据统计分析](#数据统计分析)

## 功能概览

宠物管理系统提供全方位的宠物服务管理功能，涵盖宠物信息管理、商品销售、服务预约、用户管理等核心业务模块。系统采用模块化设计，支持功能扩展和定制化开发。

### 主要功能模块
```
├── 用户管理系统
│   ├── 用户注册登录
│   ├── 个人信息管理
│   ├── 权限角色管理
│   └── 积分会员系统
├── 宠物信息管理
│   ├── 宠物档案管理
│   ├── 健康记录跟踪
│   ├── 疫苗接种管理
│   └── 成长记录管理
├── 商品管理系统
│   ├── 商品信息管理
│   ├── 库存管理
│   ├── 分类管理
│   └── 价格管理
├── 订单管理系统
│   ├── 订单创建处理
│   ├── 支付管理
│   ├── 物流跟踪
│   └── 售后服务
├── 服务预约系统
│   ├── 服务项目管理
│   ├── 预约时间管理
│   ├── 服务提供商管理
│   └── 预约状态跟踪
└── 数据统计分析
    ├── 销售数据分析
    ├── 用户行为分析
    ├── 库存分析
    └── 财务报表
```

## 用户管理系统

### 用户注册登录

#### 注册功能
- **邮箱注册**: 支持邮箱验证注册
- **手机注册**: 支持短信验证注册
- **社交登录**: 支持微信、QQ等第三方登录
- **信息完善**: 注册后引导完善个人信息

```php
// 用户注册流程
function register_user($user_data) {
    // 1. 验证用户输入
    $validation = validate_user_input($user_data);
    
    // 2. 检查用户是否已存在
    if (user_exists($user_data['email'])) {
        return ['error' => '用户已存在'];
    }
    
    // 3. 创建用户账户
    $user_id = wp_create_user(
        $user_data['username'],
        $user_data['password'],
        $user_data['email']
    );
    
    // 4. 发送验证邮件
    send_verification_email($user_id);
    
    // 5. 记录注册日志
    log_user_activity($user_id, 'register');
    
    return ['success' => true, 'user_id' => $user_id];
}
```

#### 登录功能
- **多种登录方式**: 用户名/邮箱/手机号登录
- **记住登录状态**: 支持自动登录
- **安全验证**: 支持验证码、双因子认证
- **登录限制**: 防止暴力破解

### 个人信息管理

#### 基本信息
- 用户名、昵称、头像
- 联系方式（手机、邮箱、地址）
- 个人简介、兴趣爱好
- 身份认证状态

#### 账户设置
- 密码修改
- 隐私设置
- 通知偏好
- 账户安全设置

```php
// 用户信息更新
function update_user_profile($user_id, $profile_data) {
    // 验证用户权限
    if (!current_user_can('edit_user', $user_id)) {
        return ['error' => '权限不足'];
    }
    
    // 更新基本信息
    wp_update_user([
        'ID' => $user_id,
        'display_name' => $profile_data['display_name'],
        'user_email' => $profile_data['email'],
        'description' => $profile_data['bio']
    ]);
    
    // 更新自定义字段
    update_user_meta($user_id, 'phone', $profile_data['phone']);
    update_user_meta($user_id, 'address', $profile_data['address']);
    
    return ['success' => true];
}
```

### 权限角色管理

#### 用户角色
- **管理员**: 系统全部权限
- **店长**: 商店管理权限
- **客服**: 订单处理权限
- **普通用户**: 基本购买权限
- **VIP用户**: 特殊优惠权限

#### 权限控制
```php
// 权限检查函数
function check_user_permission($user_id, $action) {
    $user = get_user_by('ID', $user_id);
    $user_roles = $user->roles;
    
    $permissions = [
        'administrator' => ['all'],
        'shop_manager' => ['manage_products', 'manage_orders'],
        'customer_service' => ['view_orders', 'update_orders'],
        'customer' => ['view_profile', 'place_orders'],
        'vip_customer' => ['view_profile', 'place_orders', 'vip_discounts']
    ];
    
    foreach ($user_roles as $role) {
        if (in_array($action, $permissions[$role]) || in_array('all', $permissions[$role])) {
            return true;
        }
    }
    
    return false;
}
```

### 积分会员系统

#### 积分规则
- **注册奖励**: 新用户注册获得积分
- **购买奖励**: 消费金额按比例获得积分
- **签到奖励**: 每日签到获得积分
- **推荐奖励**: 推荐新用户获得积分
- **评价奖励**: 商品评价获得积分

#### 会员等级
```php
// 会员等级配置
$membership_levels = [
    'bronze' => [
        'name' => '青铜会员',
        'min_points' => 0,
        'discount_rate' => 0.95,
        'benefits' => ['基础服务', '生日优惠']
    ],
    'silver' => [
        'name' => '白银会员',
        'min_points' => 1000,
        'discount_rate' => 0.90,
        'benefits' => ['优先客服', '免费配送', '生日优惠']
    ],
    'gold' => [
        'name' => '黄金会员',
        'min_points' => 5000,
        'discount_rate' => 0.85,
        'benefits' => ['专属客服', '免费配送', '生日优惠', '专属活动']
    ],
    'diamond' => [
        'name' => '钻石会员',
        'min_points' => 20000,
        'discount_rate' => 0.80,
        'benefits' => ['专属客服', '免费配送', '生日优惠', '专属活动', '定制服务']
    ]
];
```

## 宠物信息管理

### 宠物档案管理

#### 基本信息录入
- **宠物基本信息**: 姓名、品种、性别、年龄、体重
- **外观特征**: 毛色、体型、特殊标记
- **性格特点**: 活泼度、友好度、训练程度
- **照片管理**: 支持多张照片上传和管理

```php
// 宠物信息数据结构
class PetProfile {
    public $pet_id;
    public $owner_id;
    public $name;
    public $species;        // 物种（狗、猫、鸟等）
    public $breed;          // 品种
    public $gender;         // 性别
    public $birth_date;     // 出生日期
    public $weight;         // 体重
    public $color;          // 毛色
    public $microchip_id;   // 芯片编号
    public $photos;         // 照片数组
    public $personality;    // 性格特点
    public $special_notes;  // 特殊说明
    public $created_at;
    public $updated_at;
}

// 添加宠物信息
function add_pet_profile($owner_id, $pet_data) {
    global $wpdb;
    
    $table_name = $wpdb->prefix . 'pet_profiles';
    
    $result = $wpdb->insert(
        $table_name,
        [
            'owner_id' => $owner_id,
            'name' => sanitize_text_field($pet_data['name']),
            'species' => sanitize_text_field($pet_data['species']),
            'breed' => sanitize_text_field($pet_data['breed']),
            'gender' => sanitize_text_field($pet_data['gender']),
            'birth_date' => sanitize_text_field($pet_data['birth_date']),
            'weight' => floatval($pet_data['weight']),
            'color' => sanitize_text_field($pet_data['color']),
            'microchip_id' => sanitize_text_field($pet_data['microchip_id']),
            'personality' => sanitize_textarea_field($pet_data['personality']),
            'special_notes' => sanitize_textarea_field($pet_data['special_notes']),
            'created_at' => current_time('mysql')
        ]
    );
    
    if ($result) {
        $pet_id = $wpdb->insert_id;
        
        // 处理照片上传
        if (!empty($pet_data['photos'])) {
            handle_pet_photos($pet_id, $pet_data['photos']);
        }
        
        return ['success' => true, 'pet_id' => $pet_id];
    }
    
    return ['error' => '添加宠物信息失败'];
}
```

### 健康记录跟踪

#### 健康档案
- **体检记录**: 定期体检结果记录
- **病史记录**: 疾病诊断和治疗记录
- **用药记录**: 药物使用历史
- **过敏信息**: 已知过敏源记录

```php
// 健康记录数据结构
class HealthRecord {
    public $record_id;
    public $pet_id;
    public $record_type;    // 记录类型：体检、疾病、用药等
    public $date;           // 记录日期
    public $veterinarian;   // 兽医师
    public $clinic;         // 诊所/医院
    public $diagnosis;      // 诊断结果
    public $treatment;      // 治疗方案
    public $medication;     // 用药信息
    public $notes;          // 备注
    public $attachments;    // 附件（检查报告等）
    public $next_visit;     // 下次复诊时间
}

// 添加健康记录
function add_health_record($pet_id, $record_data) {
    global $wpdb;
    
    $table_name = $wpdb->prefix . 'pet_health_records';
    
    $result = $wpdb->insert(
        $table_name,
        [
            'pet_id' => $pet_id,
            'record_type' => sanitize_text_field($record_data['type']),
            'date' => sanitize_text_field($record_data['date']),
            'veterinarian' => sanitize_text_field($record_data['veterinarian']),
            'clinic' => sanitize_text_field($record_data['clinic']),
            'diagnosis' => sanitize_textarea_field($record_data['diagnosis']),
            'treatment' => sanitize_textarea_field($record_data['treatment']),
            'medication' => sanitize_textarea_field($record_data['medication']),
            'notes' => sanitize_textarea_field($record_data['notes']),
            'next_visit' => sanitize_text_field($record_data['next_visit'])
        ]
    );
    
    return $result ? ['success' => true] : ['error' => '添加记录失败'];
}
```

### 疫苗接种管理

#### 疫苗计划
- **疫苗类型**: 狂犬病、犬瘟热、猫三联等
- **接种时间**: 首次接种和加强免疫时间
- **接种记录**: 疫苗批号、接种医院、兽医师
- **提醒功能**: 自动提醒下次接种时间

```php
// 疫苗接种记录
class VaccinationRecord {
    public $vaccination_id;
    public $pet_id;
    public $vaccine_type;       // 疫苗类型
    public $vaccine_name;       // 疫苗名称
    public $batch_number;       // 批号
    public $vaccination_date;   // 接种日期
    public $next_due_date;      // 下次接种日期
    public $veterinarian;       // 接种兽医
    public $clinic;             // 接种诊所
    public $side_effects;       // 副作用记录
    public $certificate_url;    // 接种证书
}

// 疫苗提醒系统
function check_vaccination_reminders() {
    global $wpdb;
    
    $table_name = $wpdb->prefix . 'pet_vaccinations';
    $current_date = current_time('Y-m-d');
    $reminder_date = date('Y-m-d', strtotime('+30 days'));
    
    // 查找需要提醒的疫苗接种
    $due_vaccinations = $wpdb->get_results($wpdb->prepare("
        SELECT v.*, p.name as pet_name, p.owner_id, u.user_email
        FROM {$table_name} v
        JOIN {$wpdb->prefix}pet_profiles p ON v.pet_id = p.pet_id
        JOIN {$wpdb->users} u ON p.owner_id = u.ID
        WHERE v.next_due_date BETWEEN %s AND %s
        AND v.reminder_sent = 0
    ", $current_date, $reminder_date));
    
    foreach ($due_vaccinations as $vaccination) {
        // 发送提醒邮件
        send_vaccination_reminder($vaccination);
        
        // 标记提醒已发送
        $wpdb->update(
            $table_name,
            ['reminder_sent' => 1],
            ['vaccination_id' => $vaccination->vaccination_id]
        );
    }
}
```

### 成长记录管理

#### 成长轨迹
- **体重变化**: 定期体重记录和趋势分析
- **身高变化**: 幼宠成长期身高记录
- **行为发展**: 训练进度和行为改善记录
- **里程碑**: 重要成长节点记录

```php
// 成长记录功能
function track_pet_growth($pet_id, $measurement_data) {
    global $wpdb;
    
    $table_name = $wpdb->prefix . 'pet_growth_records';
    
    $result = $wpdb->insert(
        $table_name,
        [
            'pet_id' => $pet_id,
            'measurement_date' => current_time('mysql'),
            'weight' => floatval($measurement_data['weight']),
            'height' => floatval($measurement_data['height']),
            'length' => floatval($measurement_data['length']),
            'notes' => sanitize_textarea_field($measurement_data['notes'])
        ]
    );
    
    if ($result) {
        // 生成成长趋势图数据
        generate_growth_chart_data($pet_id);
        return ['success' => true];
    }
    
    return ['error' => '记录添加失败'];
}

// 生成成长趋势分析
function generate_growth_chart_data($pet_id) {
    global $wpdb;
    
    $table_name = $wpdb->prefix . 'pet_growth_records';
    
    $growth_data = $wpdb->get_results($wpdb->prepare("
        SELECT measurement_date, weight, height, length
        FROM {$table_name}
        WHERE pet_id = %d
        ORDER BY measurement_date ASC
    ", $pet_id));
    
    // 计算增长率和趋势
    $chart_data = [];
    $previous_weight = null;
    
    foreach ($growth_data as $record) {
        $growth_rate = 0;
        if ($previous_weight !== null) {
            $growth_rate = (($record->weight - $previous_weight) / $previous_weight) * 100;
        }
        
        $chart_data[] = [
            'date' => $record->measurement_date,
            'weight' => $record->weight,
            'height' => $record->height,
            'length' => $record->length,
            'growth_rate' => round($growth_rate, 2)
        ];
        
        $previous_weight = $record->weight;
    }
    
    // 保存图表数据
    update_post_meta($pet_id, 'growth_chart_data', $chart_data);
    
    return $chart_data;
}
```

## 商品管理系统

### 商品信息管理

#### 商品基本信息
- **商品名称**: 支持多语言商品名称
- **商品描述**: 详细的商品介绍和特性
- **商品分类**: 多级分类管理
- **商品标签**: 便于搜索和筛选的标签系统
- **商品图片**: 支持多图展示和360度展示

```php
// 商品数据结构
class Product {
    public $product_id;
    public $name;
    public $description;
    public $short_description;
    public $category_id;
    public $tags;
    public $sku;                // 商品编码
    public $price;              // 价格
    public $sale_price;         // 促销价格
    public $cost_price;         // 成本价格
    public $stock_quantity;     // 库存数量
    public $stock_status;       // 库存状态
    public $weight;             // 重量
    public $dimensions;         // 尺寸
    public $images;             // 图片数组
    public $attributes;         // 商品属性
    public $variations;         // 商品变体
    public $status;             // 商品状态
    public $featured;           // 是否推荐
    public $created_at;
    public $updated_at;
}

// 添加商品
function add_product($product_data) {
    // 创建WooCommerce产品
    $product = new WC_Product_Simple();
    
    // 设置基本信息
    $product->set_name($product_data['name']);
    $product->set_description($product_data['description']);
    $product->set_short_description($product_data['short_description']);
    $product->set_sku($product_data['sku']);
    $product->set_price($product_data['price']);
    $product->set_regular_price($product_data['price']);
    
    if (!empty($product_data['sale_price'])) {
        $product->set_sale_price($product_data['sale_price']);
    }
    
    // 设置库存
    $product->set_stock_quantity($product_data['stock_quantity']);
    $product->set_manage_stock(true);
    $product->set_stock_status($product_data['stock_status']);
    
    // 设置重量和尺寸
    $product->set_weight($product_data['weight']);
    $product->set_length($product_data['length']);
    $product->set_width($product_data['width']);
    $product->set_height($product_data['height']);
    
    // 设置分类
    if (!empty($product_data['category_ids'])) {
        $product->set_category_ids($product_data['category_ids']);
    }
    
    // 设置标签
    if (!empty($product_data['tag_ids'])) {
        $product->set_tag_ids($product_data['tag_ids']);
    }
    
    // 保存产品
    $product_id = $product->save();
    
    // 处理图片上传
    if (!empty($product_data['images'])) {
        handle_product_images($product_id, $product_data['images']);
    }
    
    // 设置自定义属性
    if (!empty($product_data['attributes'])) {
        set_product_attributes($product_id, $product_data['attributes']);
    }
    
    return $product_id;
}
```

#### 商品变体管理
- **颜色变体**: 不同颜色的商品选项
- **尺寸变体**: 不同尺寸的商品选项
- **规格变体**: 不同规格的商品选项
- **价格差异**: 不同变体的价格设置

```php
// 可变商品管理
function create_variable_product($product_data) {
    // 创建可变商品
    $product = new WC_Product_Variable();
    
    // 设置基本信息
    $product->set_name($product_data['name']);
    $product->set_description($product_data['description']);
    $product->set_sku($product_data['sku']);
    
    // 保存主商品
    $product_id = $product->save();
    
    // 创建属性
    $attributes = [];
    foreach ($product_data['attributes'] as $attr_name => $attr_values) {
        $attribute = new WC_Product_Attribute();
        $attribute->set_name($attr_name);
        $attribute->set_options($attr_values);
        $attribute->set_variation(true);
        $attribute->set_visible(true);
        $attributes[] = $attribute;
    }
    
    $product->set_attributes($attributes);
    $product->save();
    
    // 创建变体
    foreach ($product_data['variations'] as $variation_data) {
        $variation = new WC_Product_Variation();
        $variation->set_parent_id($product_id);
        
        // 设置变体属性
        $variation->set_attributes($variation_data['attributes']);
        $variation->set_sku($variation_data['sku']);
        $variation->set_price($variation_data['price']);
        $variation->set_regular_price($variation_data['price']);
        
        if (!empty($variation_data['sale_price'])) {
            $variation->set_sale_price($variation_data['sale_price']);
        }
        
        $variation->set_stock_quantity($variation_data['stock_quantity']);
        $variation->set_manage_stock(true);
        
        $variation->save();
    }
    
    // 同步变体价格到主商品
    WC_Product_Variable::sync($product_id);
    
    return $product_id;
}
```

### 库存管理

#### 库存监控
- **实时库存**: 实时显示商品库存数量
- **库存预警**: 低库存自动提醒
- **库存盘点**: 定期库存盘点功能
- **库存调整**: 支持库存增减调整

```php
// 库存管理类
class InventoryManager {
    
    // 检查低库存商品
    public function check_low_stock() {
        $low_stock_threshold = get_option('woocommerce_notify_low_stock_amount', 2);
        
        $args = [
            'post_type' => 'product',
            'post_status' => 'publish',
            'meta_query' => [
                [
                    'key' => '_manage_stock',
                    'value' => 'yes'
                ],
                [
                    'key' => '_stock',
                    'value' => $low_stock_threshold,
                    'compare' => '<='
                ]
            ]
        ];
        
        $low_stock_products = get_posts($args);
        
        if (!empty($low_stock_products)) {
            $this->send_low_stock_notification($low_stock_products);
        }
        
        return $low_stock_products;
    }
    
    // 库存调整
    public function adjust_stock($product_id, $quantity, $reason = '') {
        $product = wc_get_product($product_id);
        
        if (!$product) {
            return ['error' => '商品不存在'];
        }
        
        $current_stock = $product->get_stock_quantity();
        $new_stock = $current_stock + $quantity;
        
        // 更新库存
        $product->set_stock_quantity($new_stock);
        $product->save();
        
        // 记录库存变动日志
        $this->log_stock_movement($product_id, $quantity, $reason, $current_stock, $new_stock);
        
        return [
            'success' => true,
            'old_stock' => $current_stock,
            'new_stock' => $new_stock
        ];
    }
    
    // 库存变动日志
    private function log_stock_movement($product_id, $quantity, $reason, $old_stock, $new_stock) {
        global $wpdb;
        
        $table_name = $wpdb->prefix . 'stock_movements';
        
        $wpdb->insert(
            $table_name,
            [
                'product_id' => $product_id,
                'quantity_change' => $quantity,
                'reason' => $reason,
                'old_stock' => $old_stock,
                'new_stock' => $new_stock,
                'user_id' => get_current_user_id(),
                'created_at' => current_time('mysql')
            ]
        );
    }
    
    // 发送低库存通知
    private function send_low_stock_notification($products) {
        $admin_email = get_option('admin_email');
        $subject = '低库存商品提醒';
        
        $message = "以下商品库存不足，请及时补货：\n\n";
        
        foreach ($products as $product_post) {
            $product = wc_get_product($product_post->ID);
            $message .= sprintf(
                "商品名称：%s\n当前库存：%d\nSKU：%s\n\n",
                $product->get_name(),
                $product->get_stock_quantity(),
                $product->get_sku()
            );
        }
        
        wp_mail($admin_email, $subject, $message);
    }
}
```

### 价格管理

#### 价格策略
- **基础价格**: 商品的标准售价
- **促销价格**: 限时促销价格
- **会员价格**: 不同会员等级的专享价格
- **批量价格**: 批量购买的优惠价格
- **动态定价**: 根据库存和需求调整价格

```php
// 价格管理系统
class PriceManager {
    
    // 获取商品价格
    public function get_product_price($product_id, $user_id = null, $quantity = 1) {
        $product = wc_get_product($product_id);
        $base_price = $product->get_price();
        
        // 检查促销价格
        $sale_price = $this->get_sale_price($product_id);
        if ($sale_price) {
            $base_price = $sale_price;
        }
        
        // 检查会员价格
        if ($user_id) {
            $member_price = $this->get_member_price($product_id, $user_id);
            if ($member_price && $member_price < $base_price) {
                $base_price = $member_price;
            }
        }
        
        // 检查批量价格
        $bulk_price = $this->get_bulk_price($product_id, $quantity);
        if ($bulk_price && $bulk_price < $base_price) {
            $base_price = $bulk_price;
        }
        
        return $base_price;
    }
    
    // 获取会员价格
    private function get_member_price($product_id, $user_id) {
        $user_level = get_user_meta($user_id, 'membership_level', true);
        
        $member_discounts = [
            'bronze' => 0.95,
            'silver' => 0.90,
            'gold' => 0.85,
            'diamond' => 0.80
        ];
        
        if (isset($member_discounts[$user_level])) {
            $product = wc_get_product($product_id);
            return $product->get_price() * $member_discounts[$user_level];
        }
        
        return null;
    }
    
    // 获取批量价格
    private function get_bulk_price($product_id, $quantity) {
        $bulk_rules = get_post_meta($product_id, '_bulk_pricing_rules', true);
        
        if (!$bulk_rules) {
            return null;
        }
        
        foreach ($bulk_rules as $rule) {
            if ($quantity >= $rule['min_quantity']) {
                $product = wc_get_product($product_id);
                $base_price = $product->get_price();
                
                if ($rule['type'] === 'percentage') {
                    return $base_price * (1 - $rule['discount'] / 100);
                } elseif ($rule['type'] === 'fixed') {
                    return $base_price - $rule['discount'];
                }
            }
        }
        
        return null;
    }
    
    // 设置促销价格
    public function set_sale_price($product_id, $sale_price, $start_date = null, $end_date = null) {
        $product = wc_get_product($product_id);
        
        $product->set_sale_price($sale_price);
        
        if ($start_date) {
            $product->set_date_on_sale_from($start_date);
        }
        
        if ($end_date) {
            $product->set_date_on_sale_to($end_date);
        }
        
        $product->save();
        
        // 记录价格变动日志
        $this->log_price_change($product_id, 'sale_price', $sale_price, $start_date, $end_date);
        
        return true;
    }
    
    // 价格变动日志
    private function log_price_change($product_id, $price_type, $new_price, $start_date = null, $end_date = null) {
        global $wpdb;
        
        $table_name = $wpdb->prefix . 'price_changes';
        
        $wpdb->insert(
            $table_name,
            [
                'product_id' => $product_id,
                'price_type' => $price_type,
                'new_price' => $new_price,
                'start_date' => $start_date,
                'end_date' => $end_date,
                'user_id' => get_current_user_id(),
                'created_at' => current_time('mysql')
            ]
        );
    }
}
```

## 订单管理系统

### 订单创建处理

#### 订单流程
1. **购物车管理**: 商品添加、修改、删除
2. **订单创建**: 生成订单号、计算总价
3. **地址管理**: 配送地址和账单地址
4. **支付处理**: 多种支付方式支持
5. **订单确认**: 订单状态更新和通知

```php
// 订单处理类
class OrderManager {
    
    // 创建订单
    public function create_order($order_data) {
        try {
            // 创建WooCommerce订单
            $order = wc_create_order();
            
            // 设置客户信息
            if (!empty($order_data['customer_id'])) {
                $order->set_customer_id($order_data['customer_id']);
            }
            
            // 设置账单地址
            $order->set_address($order_data['billing_address'], 'billing');
            
            // 设置配送地址
            if (!empty($order_data['shipping_address'])) {
                $order->set_address($order_data['shipping_address'], 'shipping');
            }
            
            // 添加商品
            foreach ($order_data['items'] as $item) {
                $product = wc_get_product($item['product_id']);
                
                if (!$product) {
                    throw new Exception("商品不存在: {$item['product_id']}");
                }
                
                // 检查库存
                if (!$this->check_stock($item['product_id'], $item['quantity'])) {
                    throw new Exception("商品库存不足: {$product->get_name()}");
                }
                
                // 添加商品到订单
                $order->add_product($product, $item['quantity']);
            }
            
            // 添加配送费用
            if (!empty($order_data['shipping_method'])) {
                $this->add_shipping_to_order($order, $order_data['shipping_method']);
            }
            
            // 应用优惠券
            if (!empty($order_data['coupons'])) {
                foreach ($order_data['coupons'] as $coupon_code) {
                    $order->apply_coupon($coupon_code);
                }
            }
            
            // 计算总价
            $order->calculate_totals();
            
            // 设置订单状态
            $order->set_status('pending');
            
            // 保存订单
            $order->save();
            
            // 减少库存
            $this->reduce_stock($order);
            
            // 发送订单确认邮件
            $this->send_order_confirmation($order);
            
            return [
                'success' => true,
                'order_id' => $order->get_id(),
                'order_key' => $order->get_order_key()
            ];
            
        } catch (Exception $e) {
            return [
                'error' => $e->getMessage()
            ];
        }
    }
    
    // 检查库存
    private function check_stock($product_id, $quantity) {
        $product = wc_get_product($product_id);
        
        if (!$product->managing_stock()) {
            return true;
        }
        
        return $product->get_stock_quantity() >= $quantity;
    }
    
    // 减少库存
    private function reduce_stock($order) {
        foreach ($order->get_items() as $item) {
            $product = $item->get_product();
            
            if ($product->managing_stock()) {
                $new_stock = $product->get_stock_quantity() - $item->get_quantity();
                $product->set_stock_quantity($new_stock);
                $product->save();
            }
        }
    }
    
    // 发送订单确认邮件
    private function send_order_confirmation($order) {
        $mailer = WC()->mailer();
        $emails = $mailer->get_emails();
        
        if (isset($emails['WC_Email_New_Order'])) {
            $emails['WC_Email_New_Order']->trigger($order->get_id());
        }
        
        if (isset($emails['WC_Email_Customer_Processing_Order'])) {
            $emails['WC_Email_Customer_Processing_Order']->trigger($order->get_id());
        }
    }
}
```

### 订单状态管理

#### 订单状态流程
```
待付款 → 已付款 → 处理中 → 已发货 → 已完成
   ↓         ↓        ↓        ↓
 已取消   已退款   已取消   已退货
```

```php
// 订单状态管理
class OrderStatusManager {
    
    // 更新订单状态
    public function update_order_status($order_id, $new_status, $note = '') {
        $order = wc_get_order($order_id);
        
        if (!$order) {
            return ['error' => '订单不存在'];
        }
        
        $old_status = $order->get_status();
        
        // 验证状态转换是否合法
        if (!$this->is_valid_status_transition($old_status, $new_status)) {
            return ['error' => '无效的状态转换'];
        }
        
        // 更新订单状态
        $order->update_status($new_status, $note);
        
        // 执行状态相关的操作
        $this->handle_status_change($order, $old_status, $new_status);
        
        return ['success' => true];
    }
    
    // 验证状态转换
    private function is_valid_status_transition($old_status, $new_status) {
        $valid_transitions = [
            'pending' => ['processing', 'on-hold', 'cancelled'],
            'processing' => ['shipped', 'completed', 'cancelled', 'refunded'],
            'shipped' => ['completed', 'returned'],
            'on-hold' => ['processing', 'cancelled'],
            'completed' => ['returned'],
            'cancelled' => [],
            'refunded' => [],
            'returned' => []
        ];
        
        return in_array($new_status, $valid_transitions[$old_status] ?? []);
    }
    
    // 处理状态变更
    private function handle_status_change($order, $old_status, $new_status) {
        switch ($new_status) {
            case 'processing':
                $this->handle_processing_status($order);
                break;
                
            case 'shipped':
                $this->handle_shipped_status($order);
                break;
                
            case 'completed':
                $this->handle_completed_status($order);
                break;
                
            case 'cancelled':
                $this->handle_cancelled_status($order);
                break;
                
            case 'refunded':
                $this->handle_refunded_status($order);
                break;
        }
    }
    
    // 处理订单处理中状态
    private function handle_processing_status($order) {
        // 发送处理中通知邮件
        $mailer = WC()->mailer();
        $emails = $mailer->get_emails();
        
        if (isset($emails['WC_Email_Customer_Processing_Order'])) {
            $emails['WC_Email_Customer_Processing_Order']->trigger($order->get_id());
        }
        
        // 生成发货单
        $this->generate_shipping_label($order);
    }
    
    // 处理订单已发货状态
    private function handle_shipped_status($order) {
        // 发送发货通知
        $this->send_shipping_notification($order);
        
        // 更新物流信息
        $this->update_tracking_info($order);
    }
    
    // 处理订单完成状态
    private function handle_completed_status($order) {
        // 发送完成通知
        $this->send_completion_notification($order);
        
        // 增加用户积分
        $this->award_points($order);
        
        // 请求评价
        $this->request_review($order);
    }
    
    // 处理订单取消状态
    private function handle_cancelled_status($order) {
        // 恢复库存
        $this->restore_stock($order);
        
        // 发送取消通知
        $this->send_cancellation_notification($order);
    }
    
    // 处理订单退款状态
    private function handle_refunded_status($order) {
        // 恢复库存
        $this->restore_stock($order);
        
        // 处理退款
        $this->process_refund($order);
        
        // 发送退款通知
        $this->send_refund_notification($order);
    }
}
```

### 物流跟踪

#### 物流信息管理
- **物流公司**: 支持多家物流公司
- **运单号**: 自动生成或手动输入运单号
- **物流状态**: 实时跟踪物流状态
- **配送时效**: 预计配送时间

```php
// 物流跟踪系统
class ShippingTracker {
    
    // 添加物流信息
    public function add_tracking_info($order_id, $tracking_data) {
        $order = wc_get_order($order_id);
        
        if (!$order) {
            return ['error' => '订单不存在'];
        }
        
        // 保存物流信息
        update_post_meta($order_id, '_tracking_company', $tracking_data['company']);
        update_post_meta($order_id, '_tracking_number', $tracking_data['number']);
        update_post_meta($order_id, '_tracking_url', $tracking_data['url']);
        update_post_meta($order_id, '_shipped_date', current_time('mysql'));
        
        // 更新订单状态为已发货
        $order->update_status('shipped', '订单已发货，物流单号：' . $tracking_data['number']);
        
        // 发送发货通知
        $this->send_shipping_notification($order, $tracking_data);
        
        return ['success' => true];
    }
    
    // 获取物流信息
    public function get_tracking_info($order_id) {
        $tracking_company = get_post_meta($order_id, '_tracking_company', true);
        $tracking_number = get_post_meta($order_id, '_tracking_number', true);
        $tracking_url = get_post_meta($order_id, '_tracking_url', true);
        $shipped_date = get_post_meta($order_id, '_shipped_date', true);
        
        if (!$tracking_number) {
            return ['error' => '暂无物流信息'];
        }
        
        // 从物流公司API获取最新状态
        $tracking_status = $this->fetch_tracking_status($tracking_company, $tracking_number);
        
        return [
            'company' => $tracking_company,
            'number' => $tracking_number,
            'url' => $tracking_url,
            'shipped_date' => $shipped_date,
            'status' => $tracking_status
        ];
    }
    
    // 从物流公司API获取状态
    private function fetch_tracking_status($company, $tracking_number) {
        // 这里实现具体的物流公司API调用
        // 不同物流公司有不同的API接口
        
        switch ($company) {
            case 'sf':
                return $this->fetch_sf_tracking($tracking_number);
            case 'ems':
                return $this->fetch_ems_tracking($tracking_number);
            case 'sto':
                return $this->fetch_sto_tracking($tracking_number);
            default:
                return ['status' => '未知', 'details' => []];
        }
    }
    
    // 顺丰物流查询
    private function fetch_sf_tracking($tracking_number) {
        // 调用顺丰API
        $api_url = 'https://api.sf-express.com/tracking';
        $response = wp_remote_get($api_url . '?number=' . $tracking_number);
        
        if (is_wp_error($response)) {
            return ['status' => '查询失败', 'details' => []];
        }
        
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);
        
        // 解析返回数据
        return $this->parse_sf_response($data);
    }
    
    // 发送发货通知
    private function send_shipping_notification($order, $tracking_data) {
        $customer_email = $order->get_billing_email();
        $subject = '您的订单已发货 - 订单号：' . $order->get_order_number();
        
        $message = sprintf(
            "亲爱的客户，\n\n您的订单 %s 已发货。\n\n物流公司：%s\n运单号：%s\n\n您可以通过以下链接查询物流状态：\n%s\n\n感谢您的购买！",
            $order->get_order_number(),
            $tracking_data['company'],
            $tracking_data['number'],
            $tracking_data['url']
        );
        
        wp_mail($customer_email, $subject, $message);
    }
}
```

## 服务预约系统

### 服务项目管理

#### 服务类型
- **宠物医疗**: 体检、疫苗、治疗等医疗服务
- **美容护理**: 洗澡、美容、修剪等护理服务
- **寄养服务**: 短期或长期宠物寄养
- **训练课程**: 基础训练、行为矫正等训练服务

```php
// 服务项目数据结构
class ServiceItem {
    public $service_id;
    public $name;               // 服务名称
    public $category;           // 服务分类
    public $description;        // 服务描述
    public $duration;           // 服务时长（分钟）
    public $price;              // 服务价格
    public $deposit;            // 预约定金
    public $requirements;       // 服务要求
    public $available_times;    // 可预约时间段
    public $max_pets;           // 最大宠物数量
    public $provider_id;        // 服务提供商ID
    public $status;             // 服务状态
    public $created_at;
    public $updated_at;
}

// 服务管理类
class ServiceManager {
    
    // 添加服务项目
    public function add_service($service_data) {
        global $wpdb;
        
        $table_name = $wpdb->prefix . 'pet_services';
        
        $result = $wpdb->insert(
            $table_name,
            [
                'name' => sanitize_text_field($service_data['name']),
                'category' => sanitize_text_field($service_data['category']),
                'description' => sanitize_textarea_field($service_data['description']),
                'duration' => intval($service_data['duration']),
                'price' => floatval($service_data['price']),
                'deposit' => floatval($service_data['deposit']),
                'requirements' => sanitize_textarea_field($service_data['requirements']),
                'max_pets' => intval($service_data['max_pets']),
                'provider_id' => intval($service_data['provider_id']),
                'status' => 'active',
                'created_at' => current_time('mysql')
            ]
        );
        
        if ($result) {
            $service_id = $wpdb->insert_id;
            
            // 设置可预约时间段
            if (!empty($service_data['available_times'])) {
                $this->set_available_times($service_id, $service_data['available_times']);
            }
            
            return ['success' => true, 'service_id' => $service_id];
        }
        
        return ['error' => '添加服务失败'];
    }
    
    // 设置可预约时间段
    private function set_available_times($service_id, $time_slots) {
        global $wpdb;
        
        $table_name = $wpdb->prefix . 'service_time_slots';
        
        foreach ($time_slots as $slot) {
            $wpdb->insert(
                $table_name,
                [
                    'service_id' => $service_id,
                    'day_of_week' => $slot['day'],
                    'start_time' => $slot['start_time'],
                    'end_time' => $slot['end_time'],
                    'max_bookings' => $slot['max_bookings']
                ]
            );
        }
    }
    
    // 获取可预约时间
    public function get_available_times($service_id, $date) {
        global $wpdb;
        
        $day_of_week = date('w', strtotime($date));
        
        // 获取该服务在指定日期的时间段
        $time_slots = $wpdb->get_results($wpdb->prepare("
            SELECT * FROM {$wpdb->prefix}service_time_slots
            WHERE service_id = %d AND day_of_week = %d
        ", $service_id, $day_of_week));
        
        $available_times = [];
        
        foreach ($time_slots as $slot) {
            // 检查该时间段的预约情况
            $booked_count = $wpdb->get_var($wpdb->prepare("
                SELECT COUNT(*) FROM {$wpdb->prefix}service_bookings
                WHERE service_id = %d 
                AND booking_date = %s 
                AND booking_time = %s
                AND status NOT IN ('cancelled', 'completed')
            ", $service_id, $date, $slot->start_time));
            
            if ($booked_count < $slot->max_bookings) {
                $available_times[] = [
                    'time' => $slot->start_time,
                    'available_slots' => $slot->max_bookings - $booked_count
                ];
            }
        }
        
        return $available_times;
    }
}
```

### 预约管理

#### 预约流程
1. **选择服务**: 用户选择需要的服务项目
2. **选择时间**: 选择可用的预约时间
3. **填写信息**: 填写宠物信息和特殊要求
4. **支付定金**: 支付预约定金确认预约
5. **预约确认**: 系统发送预约确认通知

```php
// 预约管理类
class BookingManager {
    
    // 创建预约
    public function create_booking($booking_data) {
        global $wpdb;
        
        try {
            // 验证预约数据
            $validation = $this->validate_booking_data($booking_data);
            if (!$validation['valid']) {
                return ['error' => $validation['message']];
            }
            
            // 检查时间是否可用
            if (!$this->is_time_available($booking_data['service_id'], $booking_data['booking_date'], $booking_data['booking_time'])) {
                return ['error' => '该时间段已被预约'];
            }
            
            // 创建预约记录
            $table_name = $wpdb->prefix . 'service_bookings';
            
            $result = $wpdb->insert(
                $table_name,
                [
                    'user_id' => $booking_data['user_id'],
                    'service_id' => $booking_data['service_id'],
                    'pet_id' => $booking_data['pet_id'],
                    'booking_date' => $booking_data['booking_date'],
                    'booking_time' => $booking_data['booking_time'],
                    'special_requirements' => sanitize_textarea_field($booking_data['special_requirements']),
                    'contact_phone' => sanitize_text_field($booking_data['contact_phone']),
                    'status' => 'pending',
                    'created_at' => current_time('mysql')
                ]
            );
            
            if ($result) {
                $booking_id = $wpdb->insert_id;
                
                // 生成预约订单
                $order_id = $this->create_booking_order($booking_id, $booking_data);
                
                // 发送预约确认通知
                $this->send_booking_confirmation($booking_id);
                
                return [
                    'success' => true,
                    'booking_id' => $booking_id,
                    'order_id' => $order_id
                ];
            }
            
            return ['error' => '创建预约失败'];
            
        } catch (Exception $e) {
            return ['error' => $e->getMessage()];
        }
    }
    
    // 验证预约数据
    private function validate_booking_data($data) {
        // 检查必需字段
        $required_fields = ['user_id', 'service_id', 'pet_id', 'booking_date', 'booking_time'];
        
        foreach ($required_fields as $field) {
            if (empty($data[$field])) {
                return ['valid' => false, 'message' => "缺少必需字段: {$field}"];
            }
        }
        
        // 检查预约日期是否有效
        $booking_date = strtotime($data['booking_date']);
        $today = strtotime(date('Y-m-d'));
        
        if ($booking_date < $today) {
            return ['valid' => false, 'message' => '不能预约过去的日期'];
        }
        
        // 检查预约日期是否超出允许范围（例如：最多提前30天预约）
        $max_advance_days = 30;
        $max_date = strtotime("+{$max_advance_days} days");
        
        if ($booking_date > $max_date) {
            return ['valid' => false, 'message' => "最多只能提前{$max_advance_days}天预约"];
        }
        
        return ['valid' => true];
    }
    
    // 检查时间是否可用
    private function is_time_available($service_id, $date, $time) {
        global $wpdb;
        
        // 获取该时间段的最大预约数
        $day_of_week = date('w', strtotime($date));
        
        $max_bookings = $wpdb->get_var($wpdb->prepare("
            SELECT max_bookings FROM {$wpdb->prefix}service_time_slots
            WHERE service_id = %d AND day_of_week = %d AND start_time = %s
        ", $service_id, $day_of_week, $time));
        
        if (!$max_bookings) {
            return false; // 该时间段不可预约
        }
        
        // 检查当前预约数
        $current_bookings = $wpdb->get_var($wpdb->prepare("
            SELECT COUNT(*) FROM {$wpdb->prefix}service_bookings
            WHERE service_id = %d 
            AND booking_date = %s 
            AND booking_time = %s
            AND status NOT IN ('cancelled', 'completed')
        ", $service_id, $date, $time));
        
        return $current_bookings < $max_bookings;
    }
    
    // 创建预约订单
    private function create_booking_order($booking_id, $booking_data) {
        // 获取服务信息
        global $wpdb;
        
        $service = $wpdb->get_row($wpdb->prepare("
            SELECT * FROM {$wpdb->prefix}pet_services WHERE service_id = %d
        ", $booking_data['service_id']));
        
        // 创建WooCommerce订单
        $order = wc_create_order();
        $order->set_customer_id($booking_data['user_id']);
        
        // 添加服务作为商品
        $order->add_product(
            wc_get_product_by_sku('service_' . $service->service_id),
            1,
            [
                'booking_id' => $booking_id,
                'booking_date' => $booking_data['booking_date'],
                'booking_time' => $booking_data['booking_time']
            ]
        );
        
        $order->calculate_totals();
        $order->save();
        
        // 关联预约和订单
        $wpdb->update(
            $wpdb->prefix . 'service_bookings',
            ['order_id' => $order->get_id()],
            ['booking_id' => $booking_id]
        );
        
        return $order->get_id();
    }
    
    // 发送预约确认通知
    private function send_booking_confirmation($booking_id) {
        global $wpdb;
        
        // 获取预约详情
        $booking = $wpdb->get_row($wpdb->prepare("
            SELECT b.*, s.name as service_name, s.duration, s.price,
                   p.name as pet_name, u.user_email, u.display_name
            FROM {$wpdb->prefix}service_bookings b
            JOIN {$wpdb->prefix}pet_services s ON b.service_id = s.service_id
            JOIN {$wpdb->prefix}pet_profiles p ON b.pet_id = p.pet_id
            JOIN {$wpdb->users} u ON b.user_id = u.ID
            WHERE b.booking_id = %d
        ", $booking_id));
        
        if ($booking) {
            $subject = '预约确认 - ' . $booking->service_name;
            
            $message = sprintf(
                "亲爱的 %s，\n\n您的预约已确认：\n\n服务项目：%s\n宠物：%s\n预约时间：%s %s\n服务时长：%d分钟\n\n请按时到达，如需取消或修改预约，请提前24小时联系我们。\n\n感谢您的信任！",
                $booking->display_name,
                $booking->service_name,
                $booking->pet_name,
                $booking->booking_date,
                $booking->booking_time,
                $booking->duration
            );
            
            wp_mail($booking->user_email, $subject, $message);
        }
    }
    
    // 取消预约
    public function cancel_booking($booking_id, $reason = '') {
        global $wpdb;
        
        $booking = $wpdb->get_row($wpdb->prepare("
            SELECT * FROM {$wpdb->prefix}service_bookings WHERE booking_id = %d
        ", $booking_id));
        
        if (!$booking) {
            return ['error' => '预约不存在'];
        }
        
        // 检查是否可以取消（例如：提前24小时）
        $booking_datetime = strtotime($booking->booking_date . ' ' . $booking->booking_time);
        $current_time = current_time('timestamp');
        $hours_until_booking = ($booking_datetime - $current_time) / 3600;
        
        if ($hours_until_booking < 24) {
            return ['error' => '预约开始前24小时内不能取消'];
        }
        
        // 更新预约状态
        $result = $wpdb->update(
            $wpdb->prefix . 'service_bookings',
            [
                'status' => 'cancelled',
                'cancellation_reason' => $reason,
                'cancelled_at' => current_time('mysql')
            ],
            ['booking_id' => $booking_id]
        );
        
        if ($result) {
            // 处理退款
            if ($booking->order_id) {
                $this->process_booking_refund($booking->order_id);
            }
            
            // 发送取消通知
            $this->send_cancellation_notification($booking_id);
            
            return ['success' => true];
        }
        
        return ['error' => '取消预约失败'];
    }
}
```

## 支付系统

### 支付方式管理

#### 支持的支付方式
- **在线支付**: 支付宝、微信支付、银联支付
- **银行转账**: 支持多家银行转账
- **货到付款**: 支持货到付款服务
- **积分支付**: 使用积分抵扣部分金额
- **组合支付**: 多种支付方式组合使用

```php
// 支付管理类
class PaymentManager {
    
    // 处理支付
    public function process_payment($order_id, $payment_method, $payment_data = []) {
        $order = wc_get_order($order_id);
        
        if (!$order) {
            return ['error' => '订单不存在'];
        }
        
        switch ($payment_method) {
            case 'alipay':
                return $this->process_alipay_payment($order, $payment_data);
            case 'wechat':
                return $this->process_wechat_payment($order, $payment_data);
            case 'bank_transfer':
                return $this->process_bank_transfer($order, $payment_data);
            case 'cod':
                return $this->process_cod_payment($order);
            case 'points':
                return $this->process_points_payment($order, $payment_data);
            default:
                return ['error' => '不支持的支付方式'];
        }
    }
    
    // 支付宝支付
    private function process_alipay_payment($order, $payment_data) {
        // 调用支付宝API
        $alipay_config = [
            'app_id' => get_option('alipay_app_id'),
            'private_key' => get_option('alipay_private_key'),
            'public_key' => get_option('alipay_public_key'),
            'gateway_url' => 'https://openapi.alipay.com/gateway.do'
        ];
        
        $order_data = [
            'out_trade_no' => $order->get_order_number(),
            'total_amount' => $order->get_total(),
            'subject' => '宠物管理系统订单',
            'body' => '订单号：' . $order->get_order_number(),
            'notify_url' => home_url('/payment/alipay/notify'),
            'return_url' => home_url('/payment/alipay/return')
        ];
        
        // 生成支付链接
        $payment_url = $this->generate_alipay_url($alipay_config, $order_data);
        
        return [
            'success' => true,
            'payment_url' => $payment_url,
            'method' => 'redirect'
        ];
    }
    
    // 微信支付
    private function process_wechat_payment($order, $payment_data) {
        $wechat_config = [
            'appid' => get_option('wechat_appid'),
            'mch_id' => get_option('wechat_mch_id'),
            'key' => get_option('wechat_key'),
            'notify_url' => home_url('/payment/wechat/notify')
        ];
        
        $order_data = [
            'out_trade_no' => $order->get_order_number(),
            'total_fee' => $order->get_total() * 100, // 微信支付金额单位为分
            'body' => '宠物管理系统订单',
            'trade_type' => 'NATIVE' // 扫码支付
        ];
        
        // 调用微信统一下单API
        $result = $this->wechat_unified_order($wechat_config, $order_data);
        
        if ($result['return_code'] === 'SUCCESS' && $result['result_code'] === 'SUCCESS') {
            return [
                'success' => true,
                'qr_code' => $result['code_url'],
                'method' => 'qrcode'
            ];
        }
        
        return ['error' => '微信支付创建失败'];
    }
    
    // 积分支付
    private function process_points_payment($order, $payment_data) {
        $user_id = $order->get_customer_id();
        $points_to_use = intval($payment_data['points']);
        $points_value = $points_to_use * 0.01; // 1积分=0.01元
        
        // 检查用户积分余额
        $user_points = get_user_meta($user_id, 'points_balance', true);
        
        if ($user_points < $points_to_use) {
            return ['error' => '积分余额不足'];
        }
        
        // 检查积分使用限制
        $max_points_ratio = 0.5; // 最多使用50%积分
        $max_points_amount = $order->get_total() * $max_points_ratio;
        
        if ($points_value > $max_points_amount) {
            return ['error' => '积分使用超出限制'];
        }
        
        // 扣除积分
        $new_balance = $user_points - $points_to_use;
        update_user_meta($user_id, 'points_balance', $new_balance);
        
        // 记录积分使用记录
        $this->log_points_transaction($user_id, -$points_to_use, 'payment', $order->get_id());
        
        // 更新订单金额
        $remaining_amount = $order->get_total() - $points_value;
        
        if ($remaining_amount <= 0) {
            // 完全使用积分支付
            $order->payment_complete();
            return ['success' => true, 'method' => 'completed'];
        } else {
            // 部分积分支付，需要其他支付方式
            return [
                'success' => true,
                'remaining_amount' => $remaining_amount,
                'method' => 'partial'
            ];
        }
    }
}
```

### 支付安全

#### 安全措施
- **数据加密**: 敏感数据传输加密
- **签名验证**: 支付回调签名验证
- **防重复支付**: 订单状态检查
- **金额验证**: 支付金额一致性验证

```php
// 支付安全管理
class PaymentSecurity {
    
    // 验证支付回调
    public function verify_payment_callback($payment_method, $callback_data) {
        switch ($payment_method) {
            case 'alipay':
                return $this->verify_alipay_callback($callback_data);
            case 'wechat':
                return $this->verify_wechat_callback($callback_data);
            default:
                return false;
        }
    }
    
    // 验证支付宝回调
    private function verify_alipay_callback($data) {
        $public_key = get_option('alipay_public_key');
        
        // 获取签名
        $sign = $data['sign'];
        unset($data['sign']);
        unset($data['sign_type']);
        
        // 生成待验证字符串
        ksort($data);
        $string_to_sign = '';
        foreach ($data as $key => $value) {
            if ($value !== '' && $key !== 'sign' && $key !== 'sign_type') {
                $string_to_sign .= $key . '=' . $value . '&';
            }
        }
        $string_to_sign = rtrim($string_to_sign, '&');
        
        // 验证签名
        return openssl_verify($string_to_sign, base64_decode($sign), $public_key, OPENSSL_ALGO_SHA256) === 1;
    }
    
    // 防重复支付检查
    public function check_duplicate_payment($order_id, $transaction_id) {
        global $wpdb;
        
        // 检查订单状态
        $order = wc_get_order($order_id);
        if ($order->is_paid()) {
            return ['duplicate' => true, 'message' => '订单已支付'];
        }
        
        // 检查交易ID是否已存在
        $existing = $wpdb->get_var($wpdb->prepare("
            SELECT COUNT(*) FROM {$wpdb->prefix}payment_transactions 
            WHERE transaction_id = %s
        ", $transaction_id));
        
        if ($existing > 0) {
            return ['duplicate' => true, 'message' => '交易ID已存在'];
        }
        
        return ['duplicate' => false];
    }
    
    // 记录支付交易
    public function log_payment_transaction($order_id, $transaction_data) {
        global $wpdb;
        
        $table_name = $wpdb->prefix . 'payment_transactions';
        
        $wpdb->insert(
            $table_name,
            [
                'order_id' => $order_id,
                'transaction_id' => $transaction_data['transaction_id'],
                'payment_method' => $transaction_data['method'],
                'amount' => $transaction_data['amount'],
                'status' => $transaction_data['status'],
                'gateway_response' => json_encode($transaction_data['response']),
                'created_at' => current_time('mysql')
            ]
        );
    }
}
```

## 通知系统

### 邮件通知

#### 通知类型
- **订单通知**: 订单确认、发货、完成等状态通知
- **预约通知**: 预约确认、提醒、取消通知
- **系统通知**: 密码重置、账户安全等系统通知
- **营销通知**: 促销活动、新品推荐等营销邮件

```php
// 通知管理类
class NotificationManager {
    
    // 发送邮件通知
    public function send_email_notification($type, $recipient, $data) {
        $template = $this->get_email_template($type);
        
        if (!$template) {
            return ['error' => '邮件模板不存在'];
        }
        
        // 替换模板变量
        $subject = $this->replace_template_vars($template['subject'], $data);
        $message = $this->replace_template_vars($template['content'], $data);
        
        // 设置邮件头
        $headers = [
            'Content-Type: text/html; charset=UTF-8',
            'From: ' . get_option('blogname') . ' <' . get_option('admin_email') . '>'
        ];
        
        // 发送邮件
        $result = wp_mail($recipient, $subject, $message, $headers);
        
        // 记录发送日志
        $this->log_notification($type, $recipient, $result);
        
        return $result ? ['success' => true] : ['error' => '邮件发送失败'];
    }
    
    // 获取邮件模板
    private function get_email_template($type) {
        $templates = [
            'order_confirmation' => [
                'subject' => '订单确认 - 订单号：{{order_number}}',
                'content' => $this->get_order_confirmation_template()
            ],
            'shipping_notification' => [
                'subject' => '您的订单已发货 - 订单号：{{order_number}}',
                'content' => $this->get_shipping_notification_template()
            ],
            'booking_confirmation' => [
                'subject' => '预约确认 - {{service_name}}',
                'content' => $this->get_booking_confirmation_template()
            ],
            'booking_reminder' => [
                'subject' => '预约提醒 - {{service_name}}',
                'content' => $this->get_booking_reminder_template()
            ]
        ];
        
        return $templates[$type] ?? null;
    }
    
    // 订单确认邮件模板
    private function get_order_confirmation_template() {
        return '
        <html>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
            <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                <h2 style="color: #2c5aa0;">订单确认</h2>
                <p>亲爱的 {{customer_name}}，</p>
                <p>感谢您的订购！您的订单已确认，详情如下：</p>
                
                <div style="background: #f9f9f9; padding: 15px; margin: 20px 0; border-radius: 5px;">
                    <h3>订单信息</h3>
                    <p><strong>订单号：</strong>{{order_number}}</p>
                    <p><strong>订单日期：</strong>{{order_date}}</p>
                    <p><strong>订单金额：</strong>¥{{order_total}}</p>
                </div>
                
                <div style="background: #f9f9f9; padding: 15px; margin: 20px 0; border-radius: 5px;">
                    <h3>商品清单</h3>
                    {{order_items}}
                </div>
                
                <div style="background: #f9f9f9; padding: 15px; margin: 20px 0; border-radius: 5px;">
                    <h3>配送信息</h3>
                    <p><strong>收货人：</strong>{{shipping_name}}</p>
                    <p><strong>配送地址：</strong>{{shipping_address}}</p>
                    <p><strong>联系电话：</strong>{{shipping_phone}}</p>
                </div>
                
                <p>我们将尽快为您处理订单，如有任何问题，请随时联系我们。</p>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <p style="color: #666; font-size: 12px;">
                        此邮件由系统自动发送，请勿直接回复。<br>
                        如需帮助，请联系客服：{{customer_service_phone}}
                    </p>
                </div>
            </div>
        </body>
        </html>';
    }
    
    // 替换模板变量
    private function replace_template_vars($template, $data) {
        foreach ($data as $key => $value) {
            $template = str_replace('{{' . $key . '}}', $value, $template);
        }
        return $template;
    }
    
    // 记录通知日志
    private function log_notification($type, $recipient, $success) {
        global $wpdb;
        
        $table_name = $wpdb->prefix . 'notification_logs';
        
        $wpdb->insert(
            $table_name,
            [
                'type' => $type,
                'recipient' => $recipient,
                'status' => $success ? 'sent' : 'failed',
                'sent_at' => current_time('mysql')
            ]
        );
    }
}
```

### 短信通知

#### 短信服务
- **验证码短信**: 注册、登录验证码
- **订单短信**: 订单状态变更通知
- **预约短信**: 预约确认和提醒
- **营销短信**: 促销活动通知

```php
// 短信通知类
class SMSNotification {
    
    private $sms_config;
    
    public function __construct() {
        $this->sms_config = [
            'api_key' => get_option('sms_api_key'),
            'api_secret' => get_option('sms_api_secret'),
            'gateway_url' => get_option('sms_gateway_url')
        ];
    }
    
    // 发送短信
    public function send_sms($phone, $message, $template_id = null) {
        // 验证手机号格式
        if (!$this->validate_phone($phone)) {
            return ['error' => '手机号格式不正确'];
        }
        
        // 检查发送频率限制
        if (!$this->check_rate_limit($phone)) {
            return ['error' => '发送过于频繁，请稍后再试'];
        }
        
        // 调用短信网关API
        $result = $this->call_sms_api($phone, $message, $template_id);
        
        // 记录发送日志
        $this->log_sms($phone, $message, $result);
        
        return $result;
    }
    
    // 发送验证码
    public function send_verification_code($phone, $code) {
        $message = "您的验证码是：{$code}，5分钟内有效，请勿泄露给他人。";
        
        // 保存验证码到缓存
        set_transient('sms_code_' . $phone, $code, 300); // 5分钟有效期
        
        return $this->send_sms($phone, $message, 'verification');
    }
    
    // 验证验证码
    public function verify_code($phone, $code) {
        $stored_code = get_transient('sms_code_' . $phone);
        
        if (!$stored_code) {
            return ['error' => '验证码已过期'];
        }
        
        if ($stored_code !== $code) {
            return ['error' => '验证码不正确'];
        }
        
        // 验证成功，删除验证码
        delete_transient('sms_code_' . $phone);
        
        return ['success' => true];
    }
    
    // 验证手机号格式
    private function validate_phone($phone) {
        return preg_match('/^1[3-9]\d{9}$/', $phone);
    }
    
    // 检查发送频率限制
    private function check_rate_limit($phone) {
        $key = 'sms_rate_limit_' . $phone;
        $count = get_transient($key);
        
        if ($count === false) {
            set_transient($key, 1, 3600); // 1小时内
            return true;
        }
        
        if ($count >= 5) { // 每小时最多5条
            return false;
        }
        
        set_transient($key, $count + 1, 3600);
        return true;
    }
}
```

## 数据统计分析

### 销售数据分析

#### 销售报表
- **日销售报表**: 每日销售额、订单数、客单价
- **月销售报表**: 月度销售趋势分析
- **商品销售排行**: 热销商品统计
- **用户消费分析**: 用户消费行为分析

```php
// 数据分析类
class DataAnalytics {
    
    // 获取销售报表
    public function get_sales_report($start_date, $end_date, $group_by = 'day') {
        global $wpdb;
        
        $date_format = $this->get_date_format($group_by);
        
        $query = $wpdb->prepare("
            SELECT 
                DATE_FORMAT(post_date, %s) as period,
                COUNT(*) as order_count,
                SUM(meta_value) as total_sales,
                AVG(meta_value) as avg_order_value
            FROM {$wpdb->posts} p
            JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id
            WHERE p.post_type = 'shop_order'
            AND p.post_status IN ('wc-processing', 'wc-completed')
            AND pm.meta_key = '_order_total'
            AND p.post_date BETWEEN %s AND %s
            GROUP BY period
            ORDER BY period
        ", $date_format, $start_date, $end_date);
        
        $results = $wpdb->get_results($query);
        
        // 计算同比增长率
        $previous_period_data = $this->get_previous_period_data($start_date, $end_date, $group_by);
        
        foreach ($results as &$result) {
            $result->growth_rate = $this->calculate_growth_rate(
                $result->total_sales,
                $previous_period_data[$result->period] ?? 0
            );
        }
        
        return $results;
    }
    
    // 获取商品销售排行
    public function get_product_sales_ranking($start_date, $end_date, $limit = 10) {
        global $wpdb;
        
        $query = $wpdb->prepare("
            SELECT 
                p.ID as product_id,
                p.post_title as product_name,
                SUM(oim.meta_value) as quantity_sold,
                SUM(oim.meta_value * oim2.meta_value) as total_revenue
            FROM {$wpdb->posts} o
            JOIN {$wpdb->prefix}woocommerce_order_items oi ON o.ID = oi.order_id
            JOIN {$wpdb->prefix}woocommerce_order_itemmeta oim ON oi.order_item_id = oim.order_item_id
            JOIN {$wpdb->prefix}woocommerce_order_itemmeta oim2 ON oi.order_item_id = oim2.order_item_id
            JOIN {$wpdb->posts} p ON oim3.meta_value = p.ID
            JOIN {$wpdb->prefix}woocommerce_order_itemmeta oim3 ON oi.order_item_id = oim3.order_item_id
            WHERE o.post_type = 'shop_order'
            AND o.post_status IN ('wc-processing', 'wc-completed')
            AND o.post_date BETWEEN %s AND %s
            AND oim.meta_key = '_qty'
            AND oim2.meta_key = '_line_total'
            AND oim3.meta_key = '_product_id'
            GROUP BY product_id
            ORDER BY quantity_sold DESC
            LIMIT %d
        ", $start_date, $end_date, $limit);
        
        return $wpdb->get_results($query);
    }
    
    // 获取用户消费分析
    public function get_customer_analysis($start_date, $end_date) {
        global $wpdb;
        
        // 新客户vs老客户分析
        $customer_analysis = $wpdb->get_results($wpdb->prepare("
            SELECT 
                CASE 
                    WHEN first_order.post_date BETWEEN %s AND %s THEN 'new'
                    ELSE 'returning'
                END as customer_type,
                COUNT(DISTINCT o.post_author) as customer_count,
                COUNT(*) as order_count,
                SUM(pm.meta_value) as total_revenue,
                AVG(pm.meta_value) as avg_order_value
            FROM {$wpdb->posts} o
            JOIN {$wpdb->postmeta} pm ON o.ID = pm.post_id
            JOIN (
                SELECT post_author, MIN(post_date) as post_date
                FROM {$wpdb->posts}
                WHERE post_type = 'shop_order'
                AND post_status IN ('wc-processing', 'wc-completed')
                GROUP BY post_author
            ) first_order ON o.post_author = first_order.post_author
            WHERE o.post_type = 'shop_order'
            AND o.post_status IN ('wc-processing', 'wc-completed')
            AND o.post_date BETWEEN %s AND %s
            AND pm.meta_key = '_order_total'
            GROUP BY customer_type
        ", $start_date, $end_date, $start_date, $end_date));
        
        return $customer_analysis;
    }
    
    // 生成数据可视化图表
    public function generate_chart_data($data, $chart_type = 'line') {
        $chart_data = [
            'type' => $chart_type,
            'data' => [
                'labels' => [],
                'datasets' => []
            ],
            'options' => [
                'responsive' => true,
                'scales' => [
                    'y' => [
                        'beginAtZero' => true
                    ]
                ]
            ]
        ];
        
        // 根据数据类型生成不同的图表配置
        switch ($chart_type) {
            case 'line':
                $chart_data = $this->generate_line_chart($data);
                break;
            case 'bar':
                $chart_data = $this->generate_bar_chart($data);
                break;
            case 'pie':
                $chart_data = $this->generate_pie_chart($data);
                break;
        }
        
        return $chart_data;
    }
}
```

---

**文档说明**: 本文档详细介绍了宠物管理系统的核心功能模块，包括用户管理、宠物信息管理、商品管理、订单管理、服务预约、支付系统、通知系统和数据统计分析等。每个模块都提供了完整的功能说明和代码示例，便于开发团队理解和实现。

**版本**: v1.0  
**最后更新**: 2024年12月